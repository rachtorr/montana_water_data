---
title: "usgs_data"
output: html_document
date: "2025-07-14"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE)
library(readr)
library(tidyverse)
library(lubridate)

```

# Exploring USGS data 

## Target-chemical concentrations and microbiological results in surface water and tapwater, Montana, 2022

[Link](https://www.sciencebase.gov/catalog/item/6400a064d34edc0ffaf4ef1b) to website with more info and metadata 


## Spatial (table 1: site info)

```{r}

table1 <- read_delim("usgs/table1_site_info.csv", 
     delim = "\t", escape_double = FALSE, 
     trim_ws = TRUE)

str(table1)

table1$date = ymd(table1$`Sample_date_(yyyymmdd)`)

format_time = paste0(substr(table1$`Sample_time_(HHMM)`, 1,2),
                     ":",
                     substr(table1$`Sample_time_(HHMM)`,3,4))

table1$time = hm(format_time)

table1$datetime = as_date(table1$date, table1$time)

ggplot(table1) + 
  geom_bar(aes(x=Site_type, fill=Site_type)) +
  coord_flip() +
  ggtitle("Count of number of sites sampled, by site type")

ggplot(table1, aes(x=as_datetime(time), fill=Site_type)) + 
  geom_bar() + 
  facet_grid('date') + 
  labs(x="time", y="sample counts", fill = "site type") +
  ggtitle("Timing of sites sampled, by site type")

```

Questions from Table 1: 

- categorical data in site type - how many samples from each site? 
- when were samples taken? which day had the most sampling for each site type? What time of day was sampling the most frequent? 

---

## Table 3 Results 
```{r}
# read in the csv 
tab3 <- read_delim("usgs/table3_results.csv", 
    delim = "\t", escape_double = FALSE, 
    trim_ws = TRUE)

# preview table 
head(tab3)

# see count of how many times unique parameter names appear
table(tab3$Parameter_name)

# view summary of taable 
data.frame(table(tab3$Parameter_name)) %>% summary()

```

```{r}
# filter out parameters that are listed more than 27 times 
plist = data.frame(table(tab3$Parameter_name)) %>% 
  filter(Freq > 27) # most parameters have 26 or 27 readings 

# select the highest count of parameters and plot 
tab3 %>%  
     filter(Parameter_name %in% plist$Var1) %>% 
     ggplot(aes(x=Parameter_name)) + geom_bar() + coord_flip() + 
     ggtitle("most sampled parameters, n>27")

```

Which parameters do we care about the most? Examples of what we can do:

- if thresholds exist, see if any are over them 
- descriptive statistics for each of water site types 
- compare between groups - hypothesis testing 

### Water temperature data 

I'm going to start here with water temperature because it's what I'm most familiar with. 

We can also use this dataset to practice filtering to create subsets of data sets.

```{r}
# filter by parameter name (I know it shows up as Temperature, water' because it is first in the list when I ran head(tab3))
temp = tab3 %>% filter(Parameter_name == 'Temperature, water') %>% 
  mutate(result = as.double(Remark_and_result))

summary(temp$result)

# summarize by site type 

# factor codes to labels 
# using factor assigns labels when we plot them 
temp$site_type = factor(temp$Medium_code, levels = c("WS","WT", "WG"),
                        labels = c("Surface water", 
                                    "treated water",
                                    "ground water"))

# different options to visualize distributions  
ggplot(temp, aes(x=site_type, y=result)) + geom_boxplot()

ggplot(temp, aes(x=site_type, y=result)) + geom_violin()

ggplot(temp, aes(x=result, col=site_type)) + geom_density()

# get summaries by type 
temp %>% group_by(site_type) %>% 
  summarise_at(vars(result), list(min=min, max=max, mean=mean))


```

Medium code: 

- WG, groundwater (private well); 
- WS, surface water; 
- WT, treated water (public supply)

Based on summary statistics we can see there is a difference in means across groups, but the treated and the groundwater have similar means. We can run a t test to test for significant difference. 

```{r}

# test between private well ground water and treated well 
# first filter by code and select only results column 
gw = temp %>% filter(Medium_code == "WG") %>% select(result)
wt = temp %>% filter(Medium_code == "WT") %>% select(result)

# run t.test
t.test(gw, wt)

# we can also go surface water v one of these to compare t.test output 

gw = temp %>% filter(Medium_code == "WG") %>% select(result)
sw = temp %>% filter(Medium_code == "WS") %>% select(result)


t.test(gw, sw)

```
From the p-values, we can see the GW and WT are not significantly different, but the GW and SW are significantly different in means. 


We could repeat this process for another variable by filtering by `Parameter_name`. 


## Table 6 Microbio 

```{r}
tab6 <- read_delim("usgs/table6_microbio.csv", 
     delim = "\t", escape_double = FALSE, 
     trim_ws = TRUE)


names(tab6)

```

Three columns of results to check: 

- `HPC_CFU_per_1_mL`: heterotrophic plate count, measures the presence of microorganisms, not necessarily bad, indicator of overall bacteria amount in water. Vast majority of carbon consuming bacteria are harmless. Measured in colony forming units (CFU) per 1mL water. EPA enforces 'treatment technique' requirement that HPC concentrations should be under 500 CFU/mL. (source: [tap score](https://mytapscore.com/blogs/tips-for-taps/what-do-hpc-test-results-actually-mean))

- `Total_coliforms_CFU_per_100_mL`: fecal/environmental contamination - coliform bacteria are natural partof microbiology of intestinal tract of warm blooded mammals, also found in soil, other animals, and insects. Is an indicator bacteria for presence of disease-causing organisms. Drinking water standard is <1 or zero CFU/100mL  (source: [Know your H2O](https://www.knowyourh2o.com/indoor-6/total-coliform-bacteria))

- `E.coli_CFU_per_100_mL`: most common type of fecal coliform bacteria. Indicator of human and animal waste contamination. Exposure can cause sickness, and any amount detection is a problem for drinking water (source: [tap score](https://mytapscore.com/pages/contaminant-glossary))

```{r}
# quick summary
summary(tab6)

# fix HPC column - in summary we see it's listed as a character, but we expect this should be a double 
tab6$HPC_CFU_per_1_mL = as.double(tab6$HPC_CFU_per_1_mL)

summary(tab6$HPC_CFU_per_1_mL)

# plot the HPC distribution for each 
ggplot(tab6, aes(x=Site_type, y=HPC_CFU_per_1_mL)) + 
  geom_hline(aes(yintercept = 500), col='red') + 
  geom_boxplot() +
  ggtitle("HPC (CFU/mL)")


```

There were some samples with HPC values above 500 CFU/mL, suggesting that they would not meet EPA drinking water requirements. These were for surface water, while private wells and public supply were below this standard. 

```{r}
# plot the other columns
tab6 %>% 
  pivot_longer(cols=c(Total_coliforms_CFU_per_100_mL, E.coli_CFU_per_100_mL)) %>% 
  ggplot(aes(x=name, y=value, col=Site_type)) + 
  geom_boxplot() +
  ggtitle("Total Coliforms (CFU/100mL)") + 
  theme_minimal()

tab6 %>% 
  ggplot(aes(x=Site_type, y=E.coli_CFU_per_100_mL, col=Site_type)) + 
  geom_boxplot() + 
  ggtitle("E. coli (CFU/100mL)") + 
  theme_minimal() +
  geom_label(aes(label=E.coli_CFU_per_100_mL))
  

```

Surface water had the most e.coli detected, with at least one private well site having an outlier detected. 
No e.coli was found in the public supply samples. 

## Exploring other contaminants 

Table 3 contains results from many different contaminants and could be used for teaching and learning about water quality. 

The Environmental Protection Agency has a table for National Primary Drinking Water Regulations which lists microorganisms, metals, chemicals, and other contaminants. See the table [here](https://www.epa.gov/ground-water-and-drinking-water/national-primary-drinking-water-regulations).

The company tap score has a 'Contaminant Glossary' on their website which has information on specific contaminants. See the glossary [here](https://mytapscore.com/pages/contaminant-glossary). 

```{r}
# select contaminant 
contaminant = "lead"

# check if exists in list 
string = str_detect(tolower(unique(tab3$Parameter_name)), tolower(contaminant))
ifelse(sum(string)==0, 
   paste("contaminant not detected in list, check spelling or try different"), 
   paste(contaminant, "was found in list"))

# filter by contaminant and factor the site type 
tab3_filt = tab3 %>%
  filter(tolower(Parameter_name)==tolower(contaminant)) %>% 
  mutate(result = as.double(Remark_and_result),
         site_type = factor(Medium_code, 
                            levels = c("WS","WT", "WG"),
                            labels = c("Surface water", 
                                        "treated water",
                                        "ground water")))

# check that the result column is a number and not char 
tab3_filt$result_check = as.double(ifelse(is.na(tab3_filt$result),                      str_split_i(tab3_filt$Remark_and_result, pattern="<", 2),
          tab3_filt$result))

# check out new data frame 
dim(tab3_filt)

head(tab3_filt)


```

Questions based on EPA table:

- What are the sources of the contaminant in drinking water?
- What are the potential health effects from long term exposure?
- Who is most at risk?
- What is the threshold amount to check for?

Questions for exploring data:

- Do these samples exceed the amount? 
- For the samples that exceed it, what is the site type? 
- Which site type contains the most? the least? 

```{r}

summary(tab3_filt$result_check)

tab3_filt %>% 
  ggplot(aes(x=site_type, y=result_check)) +
  geom_boxplot() +
  ggtitle(paste(contaminant, "levels in water samples")) +
  theme_minimal() +
  labs(y=paste(unique(tab3_filt$Units_of_measurement)),
       x="site type") 

```



